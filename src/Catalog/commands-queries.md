# Catalog Service - CQRS Commands & Queries

## √çndice
- [Commands (Write Operations)](#commands-write-operations)
- [Queries (Read Operations)](#queries-read-operations)
- [Event Sourcing](#event-sourcing)

---

## Commands (Write Operations)

### üì¶ Product Commands

#### 1. CreateProductCommand
```typescript
{
  name: string;
  slug: string;
  description: string;
  shortDescription: string;
  price: number;
  compareAtPrice?: number;
  costPrice?: number;
  categoryId: UUID;
  sku: string;
  barcode?: string;
  weight?: number;
  dimensions?: string;
  images: Array<{ url: string; altText?: string }>;
}
```
**Implementa√ß√£o:**
- Valida unicidade de `slug` e `sku`
- Insere registro na tabela `products`
- Insere imagens relacionadas em `product_images`
- Trigger `publish_product_created` dispara evento `ProductCreated` no outbox
- Retorna UUID do produto criado

---

#### 2. UpdateProductCommand
```typescript
{
  productId: UUID;
  name?: string;
  slug?: string;
  description?: string;
  price?: number;
  categoryId?: UUID;
  isActive?: boolean;
  isFeatured?: boolean;
  version: number; // Optimistic locking
}
```
**Implementa√ß√£o:**
- Verifica `version` para evitar conflitos (optimistic locking)
- Atualiza apenas campos fornecidos
- Trigger `update_products_version` incrementa vers√£o automaticamente
- Trigger `publish_product_updated` detecta tipo de mudan√ßa (pre√ßo, estoque, etc.)
- Publica evento espec√≠fico (`ProductPriceChanged`, `ProductStockChanged` ou `ProductUpdated`)

---

#### 3. UpdateProductPriceCommand
```typescript
{
  productId: UUID;
  newPrice: number;
  compareAtPrice?: number;
  reason?: string;
}
```
**Implementa√ß√£o:**
- Command especializado para mudan√ßas de pre√ßo
- Registra pre√ßo anterior para auditoria
- Publica evento `ProductPriceChanged` com old/new price
- Pode integrar com servi√ßo de pricing/promotions

---

#### 4. ReserveStockCommand
```typescript
{
  productId: UUID;
  quantity: number;
  orderId: UUID;
}
```
**Implementa√ß√£o:**
- Verifica disponibilidade (`stock - stock_reserved >= quantity`)
- Incrementa `stock_reserved`
- Publica evento `StockReserved` com detalhes da reserva
- Usado pelo Order Service durante cria√ß√£o de pedido
- Implementa idempot√™ncia usando `orderId` no inbox

---

#### 5. ReleaseStockCommand
```typescript
{
  productId: UUID;
  quantity: number;
  orderId: UUID;
  reason: 'CANCELLED' | 'EXPIRED' | 'REJECTED';
}
```
**Implementa√ß√£o:**
- Decrementa `stock_reserved`
- Publica evento `StockReleased`
- Chamado quando pedido √© cancelado ou carrinho expira

---

#### 6. CommitStockCommand
```typescript
{
  productId: UUID;
  quantity: number;
  orderId: UUID;
}
```
**Implementa√ß√£o:**
- Decrementa ambos `stock` e `stock_reserved`
- Publica evento `StockCommitted`
- Executado quando pedido √© confirmado/pago

---

#### 7. AdjustStockCommand
```typescript
{
  productId: UUID;
  adjustment: number; // Pode ser negativo
  reason: string;
  adjustedBy: UUID;
}
```
**Implementa√ß√£o:**
- Ajuste manual de estoque (recebimento, invent√°rio, perdas)
- Registra no outbox para auditoria
- Atualiza `stock` diretamente

---

#### 8. SoftDeleteProductCommand
```typescript
{
  productId: UUID;
  deletedBy: UUID;
}
```
**Implementa√ß√£o:**
- Define `deleted_at = now()`
- Produto n√£o aparece mais nas queries (√≠ndices com `WHERE deleted_at IS NULL`)
- Mant√©m hist√≥rico para refer√™ncias de pedidos antigos
- Publica evento `ProductDeleted`

---

### üìÅ Category Commands

#### 9. CreateCategoryCommand
```typescript
{
  name: string;
  slug: string;
  description?: string;
  parentId?: UUID;
  displayOrder?: number;
}
```
**Implementa√ß√£o:**
- Valida unicidade de `slug`
- Verifica exist√™ncia de `parentId` se fornecido
- Insere registro em `categories`

---

#### 10. UpdateCategoryCommand
```typescript
{
  categoryId: UUID;
  name?: string;
  isActive?: boolean;
  displayOrder?: number;
}
```
**Implementa√ß√£o:**
- Atualiza√ß√£o parcial de categoria
- Pode desativar categoria (afeta exibi√ß√£o de produtos)

---

### ‚≠ê Favorite Commands

#### 11. AddToFavoritesCommand
```typescript
{
  userId: UUID;
  productId: UUID;
}
```
**Implementa√ß√£o:**
- Insere em `favorite_products` (constraint UNIQUE evita duplicatas)
- Trigger `update_favorite_count_on_insert` incrementa contador no produto
- Opera√ß√£o idempotente (ON CONFLICT DO NOTHING)

---

#### 12. RemoveFromFavoritesCommand
```typescript
{
  userId: UUID;
  productId: UUID;
}
```
**Implementa√ß√£o:**
- Remove de `favorite_products`
- Trigger `update_favorite_count_on_delete` decrementa contador

---

### ‚≠ê Review Commands

#### 13. CreateReviewCommand
```typescript
{
  productId: UUID;
  userId: UUID;
  rating: number; // 1-5
  title: string;
  comment: string;
  isVerifiedPurchase: boolean;
}
```
**Implementa√ß√£o:**
- Valida rating entre 1-5
- Define `is_approved = false` (requer modera√ß√£o)
- Trigger atualiza estat√≠sticas do produto apenas quando aprovada
- Pode verificar compra atrav√©s de evento `OrderCompleted` no inbox

---

#### 14. ApproveReviewCommand
```typescript
{
  reviewId: UUID;
  moderatorId: UUID;
}
```
**Implementa√ß√£o:**
- Define `is_approved = true`
- Registra `moderated_by` e `moderated_at`
- Trigger `update_review_stats_on_update` recalcula m√©dia e contador

---

#### 15. RejectReviewCommand
```typescript
{
  reviewId: UUID;
  moderatorId: UUID;
  reason: string;
}
```
**Implementa√ß√£o:**
- Soft delete da review (`deleted_at = now()`)
- Registra raz√£o da rejei√ß√£o no metadata

---

#### 16. VoteReviewCommand
```typescript
{
  reviewId: UUID;
  userId: UUID;
  isHelpful: boolean;
}
```
**Implementa√ß√£o:**
- Insere em `review_votes` (constraint UNIQUE evita duplicatas)
- Incrementa `helpful_count` ou `unhelpful_count` na review
- Idempotente usando UPSERT

---

### üñºÔ∏è Image Commands

#### 17. AddProductImagesCommand
```typescript
{
  productId: UUID;
  images: Array<{
    url: string;
    thumbnailUrl?: string;
    altText?: string;
    displayOrder?: number;
    isPrimary?: boolean;
  }>;
}
```
**Implementa√ß√£o:**
- Insere m√∫ltiplas imagens em `product_images`
- Se `isPrimary = true`, desmarca outras imagens como prim√°rias
- Atualiza `display_order` automaticamente

---

#### 18. SetPrimaryImageCommand
```typescript
{
  productId: UUID;
  imageId: UUID;
}
```
**Implementa√ß√£o:**
- Desmarca todas imagens do produto como prim√°rias
- Marca a imagem especificada como `is_primary = true`

---

## Queries (Read Operations)

### üîç Product Queries

#### 1. GetProductByIdQuery
```typescript
{
  productId: UUID;
  includeInactive?: boolean;
}
```
**Implementa√ß√£o:**
- Usa view `product_catalog` para dados agregados
- Retorna produto com categoria, imagens e estat√≠sticas
- Filtra `deleted_at IS NULL` por padr√£o

**Response:**
```typescript
{
  id: UUID;
  name: string;
  slug: string;
  description: string;
  price: number;
  stock: number;
  category: { id, name, slug };
  images: Array<{ url, thumbnailUrl, altText }>;
  reviewCount: number;
  reviewAvgRating: number;
  favoriteCount: number;
}
```

---

#### 2. GetProductBySlugQuery
```typescript
{
  slug: string;
}
```
**Implementa√ß√£o:**
- Similar ao `GetProductById` mas busca por slug
- Usa √≠ndice `idx_products_slug` para performance
- Incrementa `view_count` (pode ser async via evento)

---

#### 3. SearchProductsQuery
```typescript
{
  searchTerm?: string;
  categoryId?: UUID;
  minPrice?: number;
  maxPrice?: number;
  inStock?: boolean;
  isFeatured?: boolean;
  sortBy?: 'price' | 'name' | 'rating' | 'newest';
  sortOrder?: 'asc' | 'desc';
  page?: number;
  pageSize?: number;
}
```
**Implementa√ß√£o:**
- Query complexa com m√∫ltiplos filtros opcionais
- Usa `pg_trgm` para full-text search em nome/descri√ß√£o
- Aplica √≠ndices espec√≠ficos para cada filtro
- Pagina√ß√£o usando LIMIT/OFFSET
- Retorna total de resultados para navega√ß√£o

**Response:**
```typescript
{
  items: Product[];
  total: number;
  page: number;
  pageSize: number;
  totalPages: number;
}
```

---

#### 4. GetFeaturedProductsQuery
```typescript
{
  limit?: number;
  categoryId?: UUID;
}
```
**Implementa√ß√£o:**
- Usa √≠ndice `idx_products_featured`
- Ordenado por `created_at DESC` ou crit√©rio customizado
- Cache agressivo (TTL longo)

---

#### 5. GetProductsByCategoryQuery
```typescript
{
  categoryId: UUID;
  includeSubcategories?: boolean;
  page?: number;
  pageSize?: number;
}
```
**Implementa√ß√£o:**
- Se `includeSubcategories = true`, busca recursivamente categorias filhas
- Usa CTE (Common Table Expression) para hierarquia
- Ordena por `display_order` ou relev√¢ncia

---

#### 6. GetLowStockProductsQuery
```typescript
{
  threshold?: number;
  page?: number;
  pageSize?: number;
}
```
**Implementa√ß√£o:**
- Filtra `stock <= low_stock_threshold`
- Usado por dashboard administrativo
- Pode gerar alertas/notifica√ß√µes

---

#### 7. GetProductStockQuery
```typescript
{
  productId: UUID;
}
```
**Implementa√ß√£o:**
- Retorna informa√ß√µes detalhadas de estoque
```typescript
{
  stock: number;
  stockReserved: number;
  available: number; // stock - stock_reserved
  lowStockThreshold: number;
  isLowStock: boolean;
}
```

---

### üìÅ Category Queries

#### 8. GetCategoryByIdQuery
```typescript
{
  categoryId: UUID;
}
```
**Implementa√ß√£o:**
- Busca direta na tabela `categories`
- Inclui categoria pai se existir

---

#### 9. GetCategoryTreeQuery
```typescript
{
  rootCategoryId?: UUID;
  maxDepth?: number;
}
```
**Implementa√ß√£o:**
- Retorna √°rvore hier√°rquica de categorias
- Usa CTE recursiva para construir √°rvore
- Ordena por `display_order`

**Response:**
```typescript
{
  id: UUID;
  name: string;
  slug: string;
  children: CategoryTree[];
  productCount: number;
}
```

---

#### 10. GetActiveCategoriesQuery
```typescript
{
  parentId?: UUID;
}
```
**Implementa√ß√£o:**
- Filtra `is_active = true`
- Usado para menus de navega√ß√£o
- Cache de longa dura√ß√£o

---

### ‚≠ê Favorite Queries

#### 11. GetUserFavoritesQuery
```typescript
{
  userId: UUID;
  page?: number;
  pageSize?: number;
}
```
**Implementa√ß√£o:**
- JOIN entre `favorite_products` e `product_catalog` view
- Ordenado por `created_at DESC`
- Retorna produtos completos com imagens

---

#### 12. CheckIsFavoriteQuery
```typescript
{
  userId: UUID;
  productId: UUID;
}
```
**Implementa√ß√£o:**
- Consulta simples em `favorite_products`
- Retorna boolean
- Usado para toggle de favorito no frontend

---

### ‚≠ê Review Queries

#### 13. GetProductReviewsQuery
```typescript
{
  productId: UUID;
  onlyApproved?: boolean;
  sortBy?: 'recent' | 'helpful' | 'rating';
  page?: number;
  pageSize?: number;
}
```
**Implementa√ß√£o:**
- Filtra `is_approved = true` por padr√£o
- JOIN com informa√ß√µes do usu√°rio (nome pode vir de cache)
- Inclui contadores de votos

**Response:**
```typescript
{
  items: Array<{
    id: UUID;
    rating: number;
    title: string;
    comment: string;
    userName: string;
    isVerifiedPurchase: boolean;
    helpfulCount: number;
    createdAt: Date;
  }>;
  total: number;
}
```

---

#### 14. GetReviewsByUserQuery
```typescript
{
  userId: UUID;
  page?: number;
  pageSize?: number;
}
```
**Implementa√ß√£o:**
- Busca todas reviews de um usu√°rio
- JOIN com produtos para exibir nome/imagem
- √ötil para "minhas avalia√ß√µes"

---

#### 15. GetPendingReviewsQuery
```typescript
{
  page?: number;
  pageSize?: number;
}
```
**Implementa√ß√£o:**
- Filtra `is_approved = false AND deleted_at IS NULL`
- Usado por moderadores
- Ordenado por `created_at ASC` (FIFO)

---

#### 16. GetReviewStatsQuery
```typescript
{
  productId: UUID;
}
```
**Implementa√ß√£o:**
- Agrega√ß√£o de estat√≠sticas de reviews
```typescript
{
  totalReviews: number;
  averageRating: number;
  ratingDistribution: {
    1: number,
    2: number,
    3: number,
    4: number,
    5: number
  }
}
```
- Pode ser cacheado e atualizado via trigger

---

## Event Sourcing

### Outbox Events (Published)

**ProductCreated**
```json
{
  "eventType": "ProductCreated",
  "payload": {
    "productId": "uuid",
    "name": "string",
    "price": 99.90,
    "stock": 100
  }
}
```

**ProductPriceChanged**
```json
{
  "eventType": "ProductPriceChanged",
  "payload": {
    "productId": "uuid",
    "oldPrice": 99.90,
    "newPrice": 89.90
  }
}
```

**StockReserved**
```json
{
  "eventType": "StockReserved",
  "payload": {
    "productId": "uuid",
    "quantity": 2,
    "orderId": "uuid"
  }
}
```

**StockCommitted**
```json
{
  "eventType": "StockCommitted",
  "payload": {
    "productId": "uuid",
    "quantity": 2,
    "orderId": "uuid"
  }
}
```

---

### Inbox Events (Consumed)

**OrderCompleted**
```json
{
  "eventType": "OrderCompleted",
  "payload": {
    "orderId": "uuid",
    "userId": "uuid",
    "items": [{"productId": "uuid", "quantity": 1}]
  }
}
```
**Handler:** Marca `is_verified_purchase = true` para reviews deste usu√°rio/produto

**OrderCancelled**
```json
{
  "eventType": "OrderCancelled",
  "payload": {
    "orderId": "uuid",
    "items": [{"productId": "uuid", "quantity": 1}]
  }
}
```
**Handler:** Executa `ReleaseStockCommand` para cada item

---

## Boas Pr√°ticas Implementadas

### ‚úÖ Command Side
- **Idempot√™ncia:** Usar `inbox_events` para rastrear eventos processados
- **Optimistic Locking:** Campo `version` previne race conditions
- **Soft Deletes:** Manter hist√≥rico com `deleted_at`
- **Event Publishing:** Triggers autom√°ticos para Outbox Pattern
- **Valida√ß√µes:** Constraints no banco + valida√ß√µes na aplica√ß√£o

### ‚úÖ Query Side
- **Read Models:** View `product_catalog` pr√©-agrega dados
- **√çndices Estrat√©gicos:** Cobrem todos os principais filtros
- **Caching:** Queries de cat√°logo podem ter TTL longo
- **Pagina√ß√£o:** Sempre implementar para evitar sobrecarga
- **Proje√ß√µes:** Retornar apenas dados necess√°rios

### ‚úÖ Separa√ß√£o CQRS
- Commands modificam estado e publicam eventos
- Queries leem de views otimizadas
- Eventual consistency aceita (estat√≠sticas podem estar levemente desatualizadas)
- Commands retornam apenas ID/status, n√£o objetos completos

---

## Diagrama de Fluxo

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Command    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Domain      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Outbox     ‚îÇ
‚îÇ   Handler    ‚îÇ         ‚îÇ  Model       ‚îÇ         ‚îÇ   Events     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ                         ‚îÇ
                                ‚ñº                         ‚ñº
                         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                         ‚îÇ  Database    ‚îÇ         ‚îÇ   Message    ‚îÇ
                         ‚îÇ  (Write)     ‚îÇ         ‚îÇ   Broker     ‚îÇ
                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                          ‚îÇ
                                                          ‚ñº
                         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                         ‚îÇ    Query     ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ   Event      ‚îÇ
                         ‚îÇ    Handler   ‚îÇ         ‚îÇ   Handler    ‚îÇ
                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                                ‚ñº
                         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                         ‚îÇ  Read Model  ‚îÇ
                         ‚îÇ  (View)      ‚îÇ
                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

**Documenta√ß√£o T√©cnica - Catalog Service v1.0**  
*Arquitetura: CQRS + Event Sourcing + Outbox Pattern*